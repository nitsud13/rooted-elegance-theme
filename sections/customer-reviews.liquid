{% comment %}
  Customer Reviews Section
  Social proof section with testimonials carousel and optional photo gallery.
  Supports both manual testimonials and integration with review apps.
{% endcomment %}

<section
  class="reviews section"
  id="reviews-{{ section.id }}"
  aria-label="Customer reviews"
>
  {%- comment -%} Background decoration {%- endcomment -%}
  <div class="reviews__bg-pattern" aria-hidden="true">
    <svg viewBox="0 0 100 100" preserveAspectRatio="none">
      <defs>
        <pattern id="leaf-pattern-{{ section.id }}" patternUnits="userSpaceOnUse" width="60" height="60">
          <path d="M30 5C30 5 45 20 45 35C45 42 40 50 30 50C20 50 15 42 15 35C15 20 30 5 30 5Z" fill="currentColor" opacity="0.03"/>
        </pattern>
      </defs>
      <rect width="100%" height="100%" fill="url(#leaf-pattern-{{ section.id }})"/>
    </svg>
  </div>

  <div class="container">
    <header class="reviews__header">
      {%- if section.settings.show_rating_summary -%}
        <div class="reviews__rating-badge">
          <span class="reviews__rating-value">{{ section.settings.average_rating | default: '4.8' }}</span>
          <div class="reviews__rating-stars">
            {% render 'star-rating', rating: section.settings.average_rating, size: 'lg' %}
          </div>
          <span class="reviews__rating-count">Based on {{ section.settings.total_reviews | default: '2,500+' }} reviews</span>
        </div>
      {%- endif -%}

      <div class="reviews__header-content">
        {%- if section.settings.subtitle != blank -%}
          <span class="reviews__subtitle">{{ section.settings.subtitle }}</span>
        {%- endif -%}
        <h2 class="reviews__title">{{ section.settings.heading | default: 'What Our Customers Say' }}</h2>
      </div>
    </header>

    {%- comment -%} Reviews carousel {%- endcomment -%}
    <div class="reviews__carousel" data-reviews-carousel>
      <div class="reviews__track" data-reviews-track>
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when 'testimonial' -%}
              <article
                class="review-card"
                style="--delay: {{ forloop.index | times: 100 }}ms"
                {{ block.shopify_attributes }}
              >
                <div class="review-card__header">
                  <div class="review-card__rating">
                    {% render 'star-rating', rating: block.settings.rating, size: 'md' %}
                  </div>
                  {%- if block.settings.verified -%}
                    <span class="review-card__verified">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      Verified Purchase
                    </span>
                  {%- endif -%}
                </div>

                {%- if block.settings.title != blank -%}
                  <h3 class="review-card__title">{{ block.settings.title }}</h3>
                {%- endif -%}

                <blockquote class="review-card__quote">
                  <p>{{ block.settings.content }}</p>
                </blockquote>

                <footer class="review-card__footer">
                  {%- if block.settings.author_image != blank -%}
                    <img
                      src="{{ block.settings.author_image | image_url: width: 80 }}"
                      alt="{{ block.settings.author }}"
                      class="review-card__avatar"
                      loading="lazy"
                    >
                  {%- else -%}
                    <div class="review-card__avatar review-card__avatar--initials">
                      {{ block.settings.author | slice: 0 }}
                    </div>
                  {%- endif -%}

                  <div class="review-card__author-info">
                    <cite class="review-card__author">{{ block.settings.author | default: 'Happy Customer' }}</cite>
                    {%- if block.settings.location != blank -%}
                      <span class="review-card__location">{{ block.settings.location }}</span>
                    {%- endif -%}
                  </div>

                  {%- if block.settings.product != blank -%}
                    <a href="{{ block.settings.product.url }}" class="review-card__product">
                      Purchased: {{ block.settings.product.title }}
                    </a>
                  {%- endif -%}
                </footer>

                {%- if block.settings.photo != blank -%}
                  <div class="review-card__photo">
                    <img
                      src="{{ block.settings.photo | image_url: width: 400 }}"
                      alt="Customer photo of {{ block.settings.product.title | default: 'their purchase' }}"
                      loading="lazy"
                    >
                  </div>
                {%- endif -%}

                {%- comment -%} Decorative quote mark {%- endcomment -%}
                <div class="review-card__quote-mark" aria-hidden="true">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" opacity="0.1">
                    <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                  </svg>
                </div>
              </article>
          {%- endcase -%}
        {%- endfor -%}
      </div>

      {%- comment -%} Navigation dots {%- endcomment -%}
      <div class="reviews__dots" data-reviews-dots></div>
    </div>

    {%- comment -%} Customer photos grid {%- endcomment -%}
    {%- if section.settings.show_photo_gallery -%}
      <div class="reviews__gallery">
        <h3 class="reviews__gallery-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          <span>Customer Photos</span>
        </h3>
        <div class="reviews__gallery-grid">
          {%- for block in section.blocks -%}
            {%- if block.type == 'photo' and block.settings.image != blank -%}
              <a
                href="{{ block.settings.link | default: '#' }}"
                class="reviews__gallery-item"
                {{ block.shopify_attributes }}
              >
                <img
                  src="{{ block.settings.image | image_url: width: 300 }}"
                  alt="{{ block.settings.caption | default: 'Customer photo' }}"
                  loading="lazy"
                >
                <div class="reviews__gallery-overlay">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="11" y1="8" x2="11" y2="14"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                  </svg>
                </div>
              </a>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    {%- if section.settings.show_cta -%}
      <div class="reviews__cta">
        <a href="{{ section.settings.cta_link | default: '/pages/reviews' }}" class="btn btn--secondary">
          {{ section.settings.cta_text | default: 'Read All Reviews' }}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>
      </div>
    {%- endif -%}
  </div>
</section>

<style>
  .reviews {
    position: relative;
    background: var(--color-cream-warm);
    overflow: hidden;
  }

  .reviews__bg-pattern {
    position: absolute;
    inset: 0;
    pointer-events: none;
    color: var(--color-forest);
  }

  .reviews__bg-pattern svg {
    width: 100%;
    height: 100%;
  }

  .reviews__header {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-6);
    margin-bottom: var(--space-12);
  }

  .reviews__rating-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-5) var(--space-8);
    background: var(--color-white);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-lg);
  }

  .reviews__rating-value {
    font-family: var(--font-heading);
    font-size: var(--text-5xl);
    font-weight: var(--weight-bold);
    color: var(--color-forest);
    line-height: 1;
  }

  .reviews__rating-count {
    font-size: var(--text-sm);
    color: var(--color-bark-light);
  }

  .reviews__subtitle {
    display: inline-block;
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    letter-spacing: var(--tracking-wider);
    text-transform: uppercase;
    color: var(--color-earth);
  }

  .reviews__title {
    font-size: var(--text-4xl);
    margin: 0;
  }

  /* Carousel */
  .reviews__carousel {
    position: relative;
    margin-bottom: var(--space-10);
  }

  .reviews__track {
    display: flex;
    gap: var(--space-6);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: var(--space-4) var(--space-2);
    margin: calc(-1 * var(--space-4)) calc(-1 * var(--space-2));
  }

  .reviews__track::-webkit-scrollbar {
    display: none;
  }

  /* Review Card */
  .review-card {
    position: relative;
    flex: 0 0 calc(100% - var(--space-8));
    scroll-snap-align: center;
    background: var(--color-white);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    animation: fadeInUp var(--duration-slow) var(--ease-out) both;
    animation-delay: var(--delay, 0ms);
    transition: all var(--duration-normal) var(--ease-out);
  }

  .review-card:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-4px);
  }

  @media (min-width: 768px) {
    .review-card {
      flex: 0 0 calc(50% - var(--space-4));
    }
  }

  @media (min-width: 1024px) {
    .review-card {
      flex: 0 0 calc(33.333% - var(--space-5));
      padding: var(--space-8);
    }
  }

  .review-card__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .review-card__verified {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    color: var(--color-success);
  }

  .review-card__title {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    font-weight: var(--weight-semibold);
    color: var(--color-forest);
    margin: 0 0 var(--space-3);
  }

  .review-card__quote {
    margin: 0 0 var(--space-5);
    font-size: var(--text-base);
    line-height: var(--leading-relaxed);
    color: var(--color-bark);
  }

  .review-card__quote p {
    margin: 0;
  }

  .review-card__footer {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-3);
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-cream);
  }

  .review-card__avatar {
    width: 44px;
    height: 44px;
    border-radius: var(--radius-full);
    object-fit: cover;
    flex-shrink: 0;
  }

  .review-card__avatar--initials {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-sage-light), var(--color-sage));
    color: var(--color-forest);
    font-family: var(--font-heading);
    font-weight: var(--weight-semibold);
    font-size: var(--text-lg);
  }

  .review-card__author-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
  }

  .review-card__author {
    font-style: normal;
    font-weight: var(--weight-semibold);
    color: var(--color-forest);
  }

  .review-card__location {
    font-size: var(--text-sm);
    color: var(--color-sage);
  }

  .review-card__product {
    font-size: var(--text-xs);
    color: var(--color-earth);
    text-decoration: none;
    transition: color var(--duration-fast);
  }

  .review-card__product:hover {
    color: var(--color-forest);
    text-decoration: underline;
  }

  .review-card__photo {
    margin-top: var(--space-4);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .review-card__photo img {
    width: 100%;
    height: auto;
    display: block;
  }

  .review-card__quote-mark {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    pointer-events: none;
  }

  /* Navigation dots */
  .reviews__dots {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-6);
  }

  .reviews__dot {
    width: 8px;
    height: 8px;
    padding: 0;
    background: var(--color-sage-light);
    border: none;
    border-radius: var(--radius-full);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .reviews__dot:hover,
  .reviews__dot.is-active {
    background: var(--color-forest);
  }

  .reviews__dot.is-active {
    width: 24px;
  }

  /* Photo gallery */
  .reviews__gallery {
    margin-top: var(--space-12);
    padding-top: var(--space-10);
    border-top: 1px solid rgba(139, 168, 136, 0.3);
  }

  .reviews__gallery-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    font-size: var(--text-lg);
    font-weight: var(--weight-semibold);
    color: var(--color-forest);
    margin-bottom: var(--space-6);
  }

  .reviews__gallery-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-3);
  }

  @media (min-width: 768px) {
    .reviews__gallery-grid {
      grid-template-columns: repeat(6, 1fr);
      gap: var(--space-4);
    }
  }

  .reviews__gallery-item {
    position: relative;
    aspect-ratio: 1;
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .reviews__gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration-normal) var(--ease-out);
  }

  .reviews__gallery-item:hover img {
    transform: scale(1.1);
  }

  .reviews__gallery-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(27, 77, 62, 0.7);
    color: var(--color-white);
    opacity: 0;
    transition: opacity var(--duration-fast);
  }

  .reviews__gallery-item:hover .reviews__gallery-overlay {
    opacity: 1;
  }

  /* CTA */
  .reviews__cta {
    text-align: center;
    margin-top: var(--space-10);
  }

  /* Mobile adjustments */
  @media (max-width: 767px) {
    .reviews__title {
      font-size: var(--text-3xl);
    }

    .reviews__rating-value {
      font-size: var(--text-4xl);
    }

    .review-card {
      flex: 0 0 calc(100% - var(--space-4));
      padding: var(--space-5);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.getElementById('reviews-{{ section.id }}');
    if (!section) return;

    const track = section.querySelector('[data-reviews-track]');
    const dotsContainer = section.querySelector('[data-reviews-dots]');
    const cards = track.querySelectorAll('.review-card');

    if (!track || cards.length === 0) return;

    // Create dots
    cards.forEach((_, i) => {
      const dot = document.createElement('button');
      dot.className = 'reviews__dot' + (i === 0 ? ' is-active' : '');
      dot.setAttribute('aria-label', `Go to review ${i + 1}`);
      dot.addEventListener('click', () => {
        cards[i].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      });
      dotsContainer.appendChild(dot);
    });

    // Update active dot on scroll
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const index = Array.from(cards).indexOf(entry.target);
          const dots = dotsContainer.querySelectorAll('.reviews__dot');
          dots.forEach((dot, i) => dot.classList.toggle('is-active', i === index));
        }
      });
    }, {
      root: track,
      threshold: 0.6
    });

    cards.forEach(card => observer.observe(card));
  });
</script>

{% schema %}
{
  "name": "Customer Reviews",
  "tag": "section",
  "class": "section-reviews",
  "settings": [
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Testimonials"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "What Our Customers Say"
    },
    {
      "type": "checkbox",
      "id": "show_rating_summary",
      "label": "Show rating summary",
      "default": true
    },
    {
      "type": "text",
      "id": "average_rating",
      "label": "Average rating",
      "default": "4.8"
    },
    {
      "type": "text",
      "id": "total_reviews",
      "label": "Total reviews",
      "default": "2,500+"
    },
    {
      "type": "checkbox",
      "id": "show_photo_gallery",
      "label": "Show customer photos",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_cta",
      "label": "Show CTA button",
      "default": true
    },
    {
      "type": "text",
      "id": "cta_text",
      "label": "CTA button text",
      "default": "Read All Reviews"
    },
    {
      "type": "url",
      "id": "cta_link",
      "label": "CTA button link"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "range",
          "id": "rating",
          "label": "Star rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "text",
          "id": "title",
          "label": "Review title",
          "default": "Absolutely Beautiful Trees!"
        },
        {
          "type": "textarea",
          "id": "content",
          "label": "Review content",
          "default": "The trees arrived in perfect condition and have been thriving in my yard. The customer service team was incredibly helpful in choosing the right varieties for my growing zone."
        },
        {
          "type": "text",
          "id": "author",
          "label": "Author name",
          "default": "Sarah M."
        },
        {
          "type": "text",
          "id": "location",
          "label": "Location",
          "default": "Portland, OR"
        },
        {
          "type": "image_picker",
          "id": "author_image",
          "label": "Author photo"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product purchased"
        },
        {
          "type": "image_picker",
          "id": "photo",
          "label": "Customer photo"
        },
        {
          "type": "checkbox",
          "id": "verified",
          "label": "Verified purchase",
          "default": true
        }
      ]
    },
    {
      "type": "photo",
      "name": "Gallery Photo",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "caption",
          "label": "Caption"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Customer Reviews",
      "category": "Social Proof",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "rating": 5,
            "title": "Exceeded All Expectations",
            "content": "I ordered 6 privacy trees and they arrived beautifully packaged. After just one season, they've grown significantly. The zone selector helped me pick perfect varieties.",
            "author": "Michael R.",
            "location": "Austin, TX",
            "verified": true
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "rating": 5,
            "title": "Best Online Nursery Experience",
            "content": "The trees were much larger than expected and extremely healthy. Customer service answered all my planting questions promptly. Will definitely order again!",
            "author": "Jennifer L.",
            "location": "Charlotte, NC",
            "verified": true
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "rating": 5,
            "title": "Our Yard is Transformed",
            "content": "We bought flowering trees for our front yard and the neighbors keep asking where we got them. Shipping was fast and the trees look amazing.",
            "author": "David & Amy K.",
            "location": "Denver, CO",
            "verified": true
          }
        }
      ]
    }
  ]
}
{% endschema %}
