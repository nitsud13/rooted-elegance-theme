{% comment %}
  Product Card Component
  A versatile product card with zone badge, ratings, and quick-add functionality.

  Usage:
  {% render 'product-card', product: product, show_zone_badge: true %}

  Parameters:
  - product: Product object (required)
  - show_zone_badge: Boolean - Show zone compatibility badge (default: true)
  - show_quick_add: Boolean - Show quick add button (default: true)
  - show_vendor: Boolean - Show vendor name (default: false)
  - lazy_load: Boolean - Lazy load images (default: true)
  - card_class: String - Additional CSS classes
{% endcomment %}

{%- liquid
  assign show_zone_badge = show_zone_badge | default: true
  assign show_quick_add = show_quick_add | default: true
  assign show_vendor = show_vendor | default: false
  assign lazy_load = lazy_load | default: true

  assign current_variant = product.selected_or_first_available_variant
  assign featured_image = product.featured_image
  assign secondary_image = product.images[1]

  assign on_sale = false
  if current_variant.compare_at_price > current_variant.price
    assign on_sale = true
    assign savings_percent = current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round
  endif

  assign sold_out = false
  unless current_variant.available
    assign sold_out = true
  endunless

  # Zone compatibility - read from USDA Hardiness Zone metafields
  assign zone_compatible = false
  assign zone_range = ''
  assign zone_values = ''

  # Try plural metafield first (list of zones), then singular
  if product.metafields.custom.usda_hardiness_zones != blank
    assign zone_list = product.metafields.custom.usda_hardiness_zones.value
    assign normalized_zones = ''

    # Normalize zones to numeric strings (handles values like "Zone 7" or "zone-7a")
    for zone in zone_list
      assign normalized = zone | downcase | replace: 'zone', '' | replace: ' ', '' | replace: '-', '' | strip
      if normalized != ''
        if normalized_zones == ''
          assign normalized_zones = normalized
        else
          assign normalized_zones = normalized_zones | append: ',' | append: normalized
        endif
      endif
    endfor

    if normalized_zones != ''
      assign zone_compatible = true
      assign zones_array = normalized_zones | split: ','
      assign zone_values = normalized_zones
      assign first_zone = zones_array | first
      assign last_zone = zones_array | last
      assign zone_range = first_zone
      if zones_array.size > 1
        assign zone_range = first_zone | append: '-' | append: last_zone
      endif
    endif
  elsif product.metafields.custom.usda_hardiness_zone != blank
    assign normalized = product.metafields.custom.usda_hardiness_zone.value | downcase | replace: 'zone', '' | replace: ' ', '' | replace: '-', '' | strip
    if normalized != ''
      assign zone_compatible = true
      assign zone_values = normalized
      assign zone_range = normalized
    endif
  endif
-%}

<article class="product-card {{ card_class }}" data-product-id="{{ product.id }}"{% if zone_values != blank %} data-product-zone="{{ zone_values }}"{% endif %}>
  <a href="{{ product.url }}" class="product-card__link" aria-label="{{ product.title }}">

    {%- comment -%} Image container with badges {%- endcomment -%}
    <div class="product-card__media">
      {%- if featured_image != blank -%}
        <img
          class="product-card__image product-card__image--primary"
          src="{{ featured_image | image_url: width: 600 }}"
          alt="{{ featured_image.alt | default: product.title }}"
          width="{{ featured_image.width }}"
          height="{{ featured_image.height }}"
          loading="{{ lazy_load | ternary: 'lazy', 'eager' }}"
        >
        {%- if secondary_image != blank -%}
          <img
            class="product-card__image product-card__image--secondary"
            src="{{ secondary_image | image_url: width: 600 }}"
            alt="{{ secondary_image.alt | default: product.title }}"
            width="{{ secondary_image.width }}"
            height="{{ secondary_image.height }}"
            loading="lazy"
          >
        {%- endif -%}
      {%- else -%}
        <div class="product-card__placeholder">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 2L12 6M12 18L12 22M4.93 4.93L7.76 7.76M16.24 16.24L19.07 19.07M2 12L6 12M18 12L22 12M4.93 19.07L7.76 16.24M16.24 7.76L19.07 4.93"/>
            <circle cx="12" cy="12" r="4"/>
          </svg>
        </div>
      {%- endif -%}

      {%- comment -%} Badges {%- endcomment -%}
      <div class="product-card__badges">
        {%- if show_zone_badge and zone_compatible -%}
          <span class="product-card__badge product-card__badge--zone" title="Compatible with growing zones {{ zone_range }}">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="20,6 9,17 4,12"/>
            </svg>
            Zone {{ zone_range }}
          </span>
        {%- endif -%}

        {%- if on_sale -%}
          <span class="product-card__badge product-card__badge--sale">
            Save {{ savings_percent }}%
          </span>
        {%- endif -%}

        {%- if product.tags contains 'bestseller' -%}
          <span class="product-card__badge product-card__badge--bestseller">
            Bestseller
          </span>
        {%- endif -%}

        {%- if product.tags contains 'new' -%}
          <span class="product-card__badge product-card__badge--new">
            New
          </span>
        {%- endif -%}
      </div>

      {%- if sold_out -%}
        <div class="product-card__sold-out">
          <span>Sold Out</span>
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Product details {%- endcomment -%}
    <div class="product-card__content">
      {%- if show_vendor and product.vendor != blank -%}
        <p class="product-card__vendor">{{ product.vendor }}</p>
      {%- endif -%}

      <h3 class="product-card__title">{{ product.title }}</h3>

      {%- comment -%} Star rating {%- endcomment -%}
      {%- if product.metafields.reviews.rating.value != blank -%}
        {%- assign rating = product.metafields.reviews.rating.value | times: 1.0 -%}
        {%- assign rating_count = product.metafields.reviews.rating_count.value | default: 0 -%}
        {% render 'star-rating', rating: rating, count: rating_count, show_count: true %}
      {%- endif -%}

      {%- comment -%} Price {%- endcomment -%}
      <div class="product-card__price">
        {%- if on_sale -%}
          <span class="product-card__price-current product-card__price-current--sale">
            {{ current_variant.price | money }}
          </span>
          <span class="product-card__price-compare">
            <s>{{ current_variant.compare_at_price | money }}</s>
          </span>
        {%- else -%}
          <span class="product-card__price-current">
            {{ current_variant.price | money }}
          </span>
        {%- endif -%}
      </div>
    </div>
  </a>

  {%- comment -%} Quick add button {%- endcomment -%}
  {%- if show_quick_add and current_variant.available -%}
    <div class="product-card__actions">
      <form action="/cart/add" method="post" class="product-card__form">
        <input type="hidden" name="id" value="{{ current_variant.id }}">
        <input type="hidden" name="quantity" value="1">
        <button
          type="submit"
          class="product-card__add-btn"
          aria-label="Add {{ product.title }} to cart"
        >
          <span class="product-card__add-text">Add to Cart</span>
          <span class="product-card__add-icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="9" cy="21" r="1"/>
              <circle cx="20" cy="21" r="1"/>
              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              <line x1="12" y1="9" x2="12" y2="15"/>
              <line x1="9" y1="12" x2="15" y2="12"/>
            </svg>
          </span>
        </button>
      </form>
    </div>
  {%- endif -%}
</article>

<style>
  .product-card {
    position: relative;
    display: flex;
    flex-direction: column;
    background: var(--color-white);
    border-radius: var(--radius-xl);
    overflow: hidden;
    transition: all var(--duration-normal) var(--ease-out);
  }

  .product-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .product-card__link {
    display: flex;
    flex-direction: column;
    flex: 1;
    text-decoration: none;
    color: inherit;
  }

  /* Image container */
  .product-card__media {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    background: var(--color-cream-warm);
  }

  .product-card__image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: all var(--duration-slow) var(--ease-out);
  }

  .product-card__image--secondary {
    opacity: 0;
  }

  .product-card:hover .product-card__image--primary {
    opacity: 0;
    transform: scale(1.05);
  }

  .product-card:hover .product-card__image--secondary {
    opacity: 1;
    transform: scale(1);
  }

  .product-card__placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    color: var(--color-sage);
  }

  /* Badges */
  .product-card__badges {
    position: absolute;
    top: var(--space-3);
    left: var(--space-3);
    right: var(--space-3);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    z-index: 2;
  }

  .product-card__badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    font-size: 10px;
    font-weight: var(--weight-bold);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    border-radius: var(--radius-full);
    white-space: nowrap;
  }

  .product-card__badge--zone {
    background: linear-gradient(135deg, var(--color-sage-light), var(--color-sage));
    color: var(--color-forest-dark);
  }

  .product-card__badge--sale {
    background: var(--color-earth);
    color: var(--color-white);
  }

  .product-card__badge--bestseller {
    background: var(--color-forest);
    color: var(--color-white);
  }

  .product-card__badge--new {
    background: var(--color-gold);
    color: var(--color-bark);
  }

  /* Sold out overlay */
  .product-card__sold-out {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(61, 43, 31, 0.6);
    backdrop-filter: blur(2px);
    z-index: 3;
  }

  .product-card__sold-out span {
    padding: var(--space-2) var(--space-4);
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: var(--color-white);
    background: var(--color-bark);
    border-radius: var(--radius-full);
  }

  /* Content */
  .product-card__content {
    padding: var(--space-4) var(--space-5) var(--space-5);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    flex: 1;
  }

  .product-card__vendor {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    letter-spacing: var(--tracking-wide);
    text-transform: uppercase;
    color: var(--color-sage);
    margin: 0;
  }

  .product-card__title {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    font-weight: var(--weight-medium);
    line-height: var(--leading-snug);
    color: var(--color-forest);
    margin: 0;
    transition: color var(--duration-fast);
  }

  .product-card:hover .product-card__title {
    color: var(--color-earth);
  }

  /* Price */
  .product-card__price {
    display: flex;
    align-items: baseline;
    gap: var(--space-2);
    margin-top: auto;
  }

  .product-card__price-current {
    font-family: var(--font-heading);
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    color: var(--color-bark);
  }

  .product-card__price-current--sale {
    color: var(--color-earth);
  }

  .product-card__price-compare {
    font-size: var(--text-sm);
    color: var(--color-sage);
  }

  /* Quick add */
  .product-card__actions {
    padding: 0 var(--space-5) var(--space-5);
  }

  .product-card__form {
    width: 100%;
  }

  .product-card__add-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-forest);
    background: var(--color-cream);
    border: 2px solid var(--color-forest);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .product-card__add-btn:hover {
    background: var(--color-forest);
    color: var(--color-white);
    transform: translateY(-1px);
  }

  .product-card__add-btn:active {
    transform: translateY(0);
  }

  .product-card__add-icon {
    display: flex;
    transition: transform var(--duration-fast) var(--ease-spring);
  }

  .product-card__add-btn:hover .product-card__add-icon {
    transform: scale(1.1);
  }

  /* Responsive */
  @media (max-width: 767px) {
    .product-card__content {
      padding: var(--space-3) var(--space-4) var(--space-4);
    }

    .product-card__title {
      font-size: var(--text-base);
    }

    .product-card__actions {
      padding: 0 var(--space-4) var(--space-4);
    }
  }
</style>
